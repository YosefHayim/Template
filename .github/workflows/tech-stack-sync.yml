name: Tech Stack Sync

on:
  schedule:
    # Run daily at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allows manual triggering
  push:
    branches:
      - main

jobs:
  sync-tech-stack:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get all public repositories
        id: get-repos
        uses: actions/github-script@v7
        with:
          script: |
            const { data: repos } = await github.rest.repos.listForAuthenticatedUser({
              type: 'public',
              per_page: 100,
              sort: 'updated'
            });

            // Handle pagination if more than 100 repos
            let allRepos = repos;
            let page = 1;
            while (repos.length === 100) {
              const { data: nextPage } = await github.rest.repos.listForAuthenticatedUser({
                type: 'public',
                per_page: 100,
                page: page + 1,
                sort: 'updated'
              });
              if (nextPage.length === 0) break;
              allRepos = allRepos.concat(nextPage);
              page++;
            }

            const repoList = allRepos.map(repo => ({
              name: repo.name,
              full_name: repo.full_name,
              clone_url: repo.clone_url,
              default_branch: repo.default_branch
            }));

            core.setOutput('repos', JSON.stringify(repoList));
            console.log(`Found ${repoList.length} public repositories`);

      - name: Clone repositories
        run: |
          mkdir -p ./temp-repos
          mkdir -p ./repos-analysis
          echo "${{ steps.get-repos.outputs.repos }}" > repos.json
          
          # Clone each repository
          echo "${{ steps.get-repos.outputs.repos }}" | jq -r '.[] | "\(.clone_url)|\(.default_branch)|\(.name)"' | while IFS='|' read -r url branch name; do
            echo "Cloning $name..."
            git clone --depth 1 --branch "$branch" "$url" "./temp-repos/$name" || echo "Failed to clone $name"
          done

      - name: Analyze repositories with stack-analyser
        uses: specfy/stack-analyser@v1
        continue-on-error: true
        args: "./temp-repos --output ./repos-analysis/combined-analysis.json"

      - name: Aggregate tech stack
        id: aggregate
        run: |
          node scripts/aggregate-tech-stack.js

      - name: Update README.md
        id: update-readme
        run: |
          node scripts/update-readme.js
        env:
          GITHUB_OUTPUT: ${{ github.output }}

      - name: Commit and push changes
        if: steps.update-readme.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "ðŸ¤– Auto-update tech stack from all public repositories" || exit 0
          git push
